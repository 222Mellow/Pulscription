<ng-container *ngIf="viewType !== 'compact' && punkData">

  <div class="header-wrapper">
    <h1 i18n>{{ marketTitles[marketType] }}</h1>
    <h2 *ngIf="address">by <app-wallet-address [address]="address" class="highlight"></app-wallet-address></h2>

    <ng-container *ngIf="(stateSvc.marketLoading$ | async); else punkCount">
      <h3>Loading...</h3>
    </ng-container>

    <ng-template #punkCount>
      <h3>{{ (punkData | count : marketType) | number }} Punks Total</h3>
    </ng-template>
  </div>

  <div class="toolbar-wrapper">
    <div class="toolbar">
      <div class="left">

        <div class="nav-wrapper">
          <pagination-template
            #p="paginationApi"
            (pageChange)="pageChanged($event)"
            (pageBoundsCorrection)="pageChanged($event)">

            <button
              class="prev"
              [class.disabled]="p.isFirstPage()"
              (click)="p.previous()">

              <ng-template [ngTemplateOutlet]="prevIcon"></ng-template>
            </button>

            <div
              class="page-item"
              [class.current]="p.getCurrent() === page.value"
              *ngFor="let page of p.pages">

              <button
                (click)="p.setCurrent(page.value)"
                *ngIf="p.getCurrent() !== page.value; else active">

                <span>{{ page.label }}</span>
              </button>

              <ng-template #active>
                <button>
                  <span>{{ page.label }}</span>
                </button>
              </ng-template>
            </div>

            <button
              class="next"
              [class.disabled]="p.isLastPage()"
              (click)="p.next()">

              <ng-template [ngTemplateOutlet]="nextIcon"></ng-template>
            </button>
          </pagination-template>
        </div>
      </div>

      <div class="right">

        <div
          class="wrapped-filter"
          [class.disabled]="marketType === 'bids' || marketType === 'all'">

          <div class="label">Show:</div>
          <ng-select
            [(ngModel)]="activeWrappedFilterModel"
            [items]="wrappedFilters"
            (change)="setWrappedFilter($event)"
            [searchable]="false"
            [clearable]="false">
          </ng-select>
        </div>

        <div
          class="sort-wrapper"
          [class.disabled]="marketType === 'all'">

          <div class="label">Sort:</div>
          <ng-select
            [(ngModel)]="activeSortModel"
            [items]="sorts"
            (change)="setSort($event)"
            [searchable]="false"
            [clearable]="false">
          </ng-select>
        </div>

        <button (click)="filtersVisible = !filtersVisible">Filter by Attribute</button>
      </div>
    </div>
  </div>

  <div
    class="filter-wrapper"
    *ngIf="filtersVisible">

    <div
      #filters
      class="filters-inner"
      [class.active]="filtersVisible">

      <div
        [id]="key"
        class="filter-group-wrapper"
        *ngFor="let key of objectKeys(dataSvc.filterData); let i = index">

        <ng-select
          [(ngModel)]="activeFiltersModel[key]"
          placeholder="{{ key | titlecase }}"
          (change)="selectFilter($event, key)"
          [searchable]="true">

          <ng-option
            *ngFor="let item of dataSvc.filterData[key]"
            [value]="item">

            {{ item.replaceAll('-', ' ') | titlecase }}
          </ng-option>
        </ng-select>
      </div>

      <div class="filter-group-wrapper">
        <ng-select
          [items]="[0, 1, 2, 3, 4, 5, 6, 7]"
          [(ngModel)]="traitCount"
          [searchable]="false"
          placeholder="Trait Count">
        </ng-select>
      </div>
    </div>
  </div>
</ng-container>

<div
  *ngIf="punkData; else placeholder"
  class="grid-wrapper"
  [class]="viewType">

  <ng-container *ngFor="let item of punkData |
    properties : (activeFilters$ | async) : traitCount |
    filter: marketType : (activeWrappedFilters$ | async) |
    sort: ((activeSort$ | async)?.value || sorts[0].value) : marketType |
    paginate: {
      itemsPerPage: limit,
      currentPage: currentPage
    };
    trackBy: identify;
    index as i">

    <ng-container *ngTemplateOutlet="punkItem; context:{ $implicit: item, idx: i }"></ng-container>
  </ng-container>
</div>

<ng-template #punkItem let-item>
  <div class="item">

    <ng-container *ngIf="viewType !== 'compact'">
      <ng-container *ngIf="item.listing?.source as source">
        <a
          [href]="item.listing?.source?.url"
          target="_blank"
          class="listing-source">
          <img
            [src]="source.icon"
            width="20"
            height="20"
          />
        </a>
      </ng-container>
    </ng-container>

    <a
      class="item-link"
      [routerLink]="['/', 'details', item.id]"
      [href]="'/details/' + item.id">

      <div
        class="image-wrapper"
        [class.listing]="marketType === 'listings' && item?.listing"
        [class.bid]="marketType === 'bids' && item?.bid"
        [class.wrapped]="item?.wrapped">

        <img
          [lazyLoad]="dataSvc.staticUrl + '/phunk' + (item.id | tokenIdParse) + '.svg'"
          [defaultImage]="'assets/loadingphunk.png'"
          width="50"
          height="50"
        />
      </div>

      <div
        class="labels-wrapper"
        *ngIf="viewType !== 'compact'">

        <div class="label">#{{ item.id }}</div>

        <ng-container *ngIf="marketType === 'listings'">
          <ng-container *ngIf="item.listing as listing">
            <p i18n>
              {{ (listing.value | weiToEth) | formatCash }}Ξ<br />
              ${{ ((listing.value | weiToEth) * ((dataSvc.usd$ | async) || 0)) | formatCash }}
            </p>
          </ng-container>
        </ng-container>

        <ng-container *ngIf="marketType === 'bids'">
          <ng-container *ngIf="item.bid as bid">
            <p i18n>
              {{ (bid.value | weiToEth) | formatCash }}Ξ<br />
              ${{ ((bid.value | weiToEth) * ((dataSvc.usd$ | async) || 0)) | formatCash }}
            </p>
          </ng-container>
        </ng-container>

      </div>
    </a>

  </div>
</ng-template>

<ng-template #placeholder>
  <div
    class="grid-wrapper"
    [class]="viewType">

    <div class="item-link" *ngFor="let i of limitArr">
      <div class="item">

        <div class="image-wrapper">
          <img
            [src]="'assets/loadingphunk.png'"
            width="50"
            height="50"
          />
        </div>

        <div
          class="labels-wrapper"
          *ngIf="viewType !== 'compact'">

          <div class="label">#0000</div>
          <div class="label">Loading...<br />&nbsp;</div>
        </div>
      </div>
    </div>
  </div>
</ng-template>

<ng-template #prevIcon>
  <svg height="13" viewBox="0 0 8 13" width="8" xmlns="http://www.w3.org/2000/svg"><path d="m5.203125 10.40625v2.5664062h2.6015625v-2.5664062zm-2.6015625-2.6015625v2.6015625h2.6015625v-2.6015625zm-2.6015625-2.6015625v2.6015625h2.6015625v-2.6015625zm2.6015625-2.6015625v2.6015625h2.6015625v-2.6015625zm2.6015625-2.6015625v2.6015625h2.6015625v-2.6015625z" fill="rgba(var(--text-color), 1)"/></svg>
</ng-template>

<ng-template #nextIcon>
  <svg height="13" viewBox="0 0 8 13" width="8" xmlns="http://www.w3.org/2000/svg"><path d="m2.6015625 10.40625v2.5664062h-2.6015625v-2.5664062zm2.6015625-2.6015625v2.6015625h-2.6015625v-2.6015625zm2.6015625-2.6015625v2.6015625h-2.6015625v-2.6015625zm-2.6015625-2.6015625v2.6015625h-2.6015625v-2.6015625zm-2.6015625-2.6015625v2.6015625h-2.6015625v-2.6015625z" fill="rgba(var(--text-color), 1)"/></svg>
</ng-template>
